name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    # Run every Sunday at midnight
    - cron: "0 0 * * 0"

defaults:
  run:
    shell: bash -l {0}

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # Oldest supported versions
          - name: Linux (CUDA 11.8, Python 3.10, PyTorch 2.0)
            enable_cuda: true
            cuda: "11.8.0"
            gcc: "10.3.*"
            nvcc: "11.8"
            python: "3.10.*"
            torchani: "2.2.*"
            pytorch: "2.0.*"

          # Latest supported versions (with CUDA)
          - name: Linux (CUDA 12, Python 3.13, PyTorch 2.5)
            enable_cuda: true
            cuda: "12.6.0"
            gcc: "10.3.*"
            nvcc: "12.*"
            python: "3.13.*"
            torchani: "2.2.*"
            pytorch: "2.5.*"

    steps:
      - name: Check out
        uses: actions/checkout@v2

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.21
        with:
          cuda: ${{ matrix.cuda }}
          linux-local-args: '["--toolkit", "--override"]'
          log-file-suffix: "${{ matrix.cuda }}.txt"
        if: ${{ matrix.enable_cuda }}

      - name: Install Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ matrix.python }}
          channels: conda-forge
          mamba-version: "*"
          conda-remove-defaults: "true"

      - name: Install dependencies
        run: |
          mamba install -c conda-forge gxx_linux-64=${{ matrix.gcc }} python-build

      - name: Build package
        run: |
          python -m build
        env:
          ENABLE_CUDA: ${{ matrix.enable_cuda && '1' || '0' }}

      - name: Install package
        run: |
          mamba create -n nnpops -y
          mamba activate nnpops
          mamba install python=${{ matrix.python }} pytest mdtraj torchani=${{ matrix.torchani }}
          pip install dist/*.whl

      - name: Test
        run: |
          mamba activate nnpops
          pytest ./tests/ -v -s --durations=10
