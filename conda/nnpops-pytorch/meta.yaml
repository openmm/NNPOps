{% set name = "nnpops-pytorch" %}
{% set version = "0.0.0a4" %}
{% set build = 0 %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  path: ../..

build:
  number: {{ build }}
  rpaths:
    - lib/
    # Note: $PY_VER isn't expanded here
    - lib/python3.6/site-packages/torch/lib/ # [py==36]
    - lib/python3.7/site-packages/torch/lib/ # [py==37]
    - lib/python3.8/site-packages/torch/lib/ # [py==38]
    - lib/python3.9/site-packages/torch/lib/ # [py==39]
  script:
    - cmake $SRC_DIR/pytorch
            -DCMAKE_CUDA_COMPILER=/usr/local/cuda-10.2/bin/nvcc
            -DCMAKE_CUDA_HOST_COMPILER=$CXX
            -DTorch_DIR=$PREFIX/lib/python$PY_VER/site-packages/torch/share/cmake/Torch
            -DCMAKE_BUILD_TYPE=Release
            -DCMAKE_INSTALL_PREFIX=$PREFIX
    - make install VERBOSE=1

requirements:
  build:
    - cmake
    - gxx_linux-64 <9 # CUDA 10.2 doesn't support GCC 9
    - make
  host:
    - cudatoolkit 10.2.*
    - python
    - pytorch 1.8.0 cuda*
  run:
    - cudatoolkit 10.2.*
    - pytorch >=1.8 cuda*
    - torchani >=2.2

test:
  requires:
    - conda-build
    - mdtraj
    - pytest
  source_files:
    - pytorch/molecules
    - pytorch/Test*.py
  commands:
    - conda inspect linkages {{ name }}
    - cd pytorch && pytest Test*.py

about:
  home: https://github.com/peastman/NNPOps
  license: MIT
  license_file: LICENSE
  summary: Optimized operations for the neural network potentials